# MSX Memory Management Unit

## メモリレイアウト

- 実機 MSX では、64KB のメモリ全体（$0000 ~ $FFFF）を、16KB / 1 Page 単位で区切ったメモリレイアウトになっている
- 各ページには、システム上に幾つかある スロット（基本スロット）の何れかが紐付けられる
- 基本スロットのサイズは 16KB である
- 基本スロットは各 4 つの拡張スロット（各 16KB）に拡張できる

```text
+------------------------+----------------+------------------------+
| Page 0 ($0000 ~ $3FFF) | Slot 00 (16KB) | EXTRA Slot 00-0 (16KB) |
|                        |                +------------------------+
|                        |                | EXTRA Slot 00-1 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 00-2 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 00-3 (16KB) |
+------------------------+----------------+------------------------+
| Page 1 ($4000 ~ $7FFF) | Slot 01 (16KB) | EXTRA Slot 01-0 (16KB) |
|                        |                +------------------------+
|                        |                | EXTRA Slot 01-1 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 01-2 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 01-3 (16KB) |
+------------------------+----------------+------------------------+
| Page 2 ($8000 ~ $BFFF) | Slot 02 (16KB) | EXTRA Slot 02-0 (16KB) |
|                        |                +------------------------+
|                        |                | EXTRA Slot 02-1 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 02-2 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 02-3 (16KB) |
+------------------------+----------------+------------------------+
| Page 3 ($C000 ~ $3FFF) | Slot 03 (16KB) | EXTRA Slot 03-0 (16KB) |
|                        |                +------------------------+
|                        |                | EXTRA Slot 03-1 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 03-2 (16KB) |
|                        |                |------------------------+
|                        |                | EXTRA Slot 03-3 (16KB) |
+------------------------+----------------+------------------------+
```

## Page への基本スロット割り当て

OUT $FF ~ $FC で Page 0 ~ 3 に割り当てる 基本スロット番号 ($00 ~ $FF) を指定できる

- $FF: Page 0 の 基本スロット番号($00 ~ $FF) を指定
- $FE: Page 1 の 基本スロット番号($00 ~ $FF) を指定
- $FD: Page 2 の 基本スロット番号($00 ~ $FF) を指定
- $FC: Page 3 の 基本スロット番号($00 ~ $FF) を指定

各 Page には任意のスロットを割り当てることができる。

MSX がブート時は、Page 0 に スロット $00-0 が割り当てられており、プログラムカウンタ $0000 から CPU が動作を始める。

C-BIOS の実装によると、初期動作で Page 0 ~ 3 に スロット $00 ~ $03 の割り当て処理が実行されているが分かる。

```asm
[0000] DI
[0001] JP $0D12
[0D12] LD A<$00>, $82
[0D14] OUT ($AB), A<$82>
[0D16] LD A<$82>, $50
[0D18] OUT ($AA), A<$50>
[0D1A] XOR A<$50>, A<$50>
[0D1B] OUT ($FF), A<$00>
[0D1D] INC A<$00>
[0D1E] OUT ($FE), A<$01>
[0D20] INC A<$01>
[0D21] OUT ($FD), A<$02>
[0D23] INC A<$02>
[0D24] OUT ($FC), A<$03>
```
