# MSX Slot

## 概要

- スロットはメモリを増設するシステムです。
- このシステムは最初から標準化されています。
- スロットに配置されたメモリを 16KB のページ単位で CPU にルーティングすることができます。
- Z80 ではせいぜい 64KB までしかアドレスできないので必要です。

### スロットの中身

- スロットには、RAM、ROM、または他のデバイス（例：マッパー）を入れることができます。
- また、空であることも可能です。
- 各スロットは 64KB の RAM または ROM をアドレスすることができます。
- これは、以下のエリアにある 4 つのページに分割されています。
  - $0000 - $3FFF
  - $4000 - $7FFF
  - $8000 - $BFFF
  - $C000 - $FFFF

### スロットの種類

- スロットには、プライマリスロットとセカンダリスロットの 2 種類があります。
- 4 つのプライマリ・スロットがあり、それぞれを 4 つのセカンダリ・スロットに拡張することができ、合計で最大 16 個のスロットを備えています。
- 通常、プライマリ・スロットのうち 2 つは外部カートリッジ・スロットとしてユーザーに公開されており、他のスロットは内部で使用されます。
- 内部スロットは拡張されることが多いですが、外部スロットは拡張されません。
- 外部スロットの拡張は、スロット・エキスパンダを使用してユーザーに任されています。
- セカンダリスロットは通常、以下のように番号が付けられています。
  - スロット `<プライマリ・スロット番号>` - `<セカンダリ・スロット番号>`

### スロットの配置

- すべての MSX は、プライマリスロット 0 またはセカンダリスロット 0-0 にメイン ROM を搭載しています（変数 `EXPTBL` を参照）
- コンピュータの上にあるカートリッジスロットは、通常スロット 1 です。
- 別の拡張ポートがある場合は、スロット 2 になります。
- 内部 RAM はスロット 3 にあることが望ましいですが、MSX1 の場合はそうではないことが多いです。
- 必ずしもこの限りではない

### サブ ROM の配置（MSX2）

- MSX2 では、スロット 0 は通常拡張されます。
- スロット 3 も同様です。
- これは、これらのコンピュータでは、サブ ROM やディスクドライブ、漢字 ROM、ファームウェアなどのメモリが必要になるため、より多くのメモリが必要になるからです。
- これらのコンピュータでは、メイン BIOS はスロット 0-0 に、サブ ROM はセカンダリスロット 0-X または 3-X に配置されています。
- 必ずしもこの限りではない

## プログラミング

### プライマリスロット

- I/O ポート $A8 でプライマリ・スロット・レジスタにアクセスできる
- これは、Z80 が対応するページでアドレスできるスロットを選択する
- 各ビットのペアは 1 ページを表し、ビットの値はスロット番号を表す
- I/O ポート A8h は読み出すこともできる

### セカンダリスロット

- セカンダリスロットにアクセスするためには、まず、3 ページ目で対応するプライマリスロット（$C000-$FFFF）を選択して、$FFFF アドレスを介してセカンダリスロットレジスタ（このプライマリスロットの）にアクセスできるようにする必要がある
- アドレス FFFFFh は読み出すことができるが、BIOS による拡張スロットの検出のため、全てのビットを反転して返す
  - つまり、このアドレスに書き込まれた値を取得するには、アセンブラで「CPL」を実行するか、BASIC で「XOR 255」を実行する必要がある

### BIOS 処理

- BIOS はこれらのプライマリスロットとセカンダリスロットを自動的に処理する
- これはバイトで、ビット 0 と 1 がプライマリスロットの番号を表し、ビット 7 がスロットの拡張の有無を表し、ビット 7 がセットされている場合はビット 2 と 3 がセカンダリスロットの番号を表す。
