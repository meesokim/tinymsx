# TMS9918A 仕様書

本ドキュメントは、TMS9918A のエミュレータ開発に必要な技術資料を纏めたものです。

## 参考文献

- [cbmeeks/TMS9918](https://github.com/cbmeeks/TMS9918) の [tms9918a.txt](https://github.com/cbmeeks/TMS9918/blob/master/tms9918a.txt)

## 目次

```text
1) 概要
 1.1) 色
 1.2) レジスタ
 1.3) 外部ビデオ

2) VDPのI/O
 2.1) メモリアクセス
 2.2) レジスタアクセス
 2.3) I/Oポートのクセ
 2.4) 割り込み

3) 画面モード
 3.1) Mode 0
 3.2) Mode 1
 3.3) Mode 2
 3.4) Mode 3
 3.5) Mode 1 + 2 (undocumented)
 3.6) Mode 2 + 3 (undocumented)
 3.7) その他 (Mode 1+3 と Mode 1+2+3)

4) スプライトシステム
 4.1) スプライト属性
 4.2) スプライトパターンサイズ
 4.3) 誤ったスプライトと衝突
```

## 1) 概要

- ビデオメモリ: 16kB or 4kB
- 解像度: 256x192 ピクセル
- 周辺にはレジスタで設定できるボーダーカラー（バックドロップ）がある
- スプライトサブシステムもあり、水平線上に最大 4 個のスプライトを配置可能
- チップ種別: PAL / NTSC
  - 割り込み速度: PAL = 50Hz, NTSC = 60Hz
  - PAL / NTSC で色が異なる

### 1.1) 色

> 訳注: TMS9918A の色は固定の 15 色+透明色です。
> 実機はアナログカラーですが、下表はデジタル（RGB）の近似色を示します。

| No. | Name         |  R   |  G   |  B   |              Preview               |
| :-: | :----------- | :--: | :--: | :--: | :--------------------------------: |
| 0x0 | Transparent  |      |      |      |                                    |
| 0x1 | Black        | 0x00 | 0x00 | 0x00 | ![#000000](image/color_000000.png) |
| 0x2 | Medium green | 0x21 | 0xC8 | 0x42 | ![#21C842](image/color_21C842.png) |
| 0x3 | Light green  | 0x5E | 0xDC | 0x78 | ![#5EDC78](image/color_5EDC78.png) |
| 0x4 | Dark blue    | 0x54 | 0x55 | 0xED | ![#5455ED](image/color_5455ED.png) |
| 0x5 | Light blue   | 0x7D | 0x76 | 0xFC | ![#7D76FC](image/color_7D76FC.png) |
| 0x6 | Dark red     | 0xD4 | 0x52 | 0x4D | ![#D4524D](image/color_D4524D.png) |
| 0x7 | Cyan         | 0x42 | 0xEB | 0xF5 | ![#42EBF5](image/color_42EBF5.png) |
| 0x8 | Medium red   | 0xFC | 0x55 | 0x54 | ![#FC5554](image/color_FC5554.png) |
| 0x9 | Light red    | 0xFF | 0x79 | 0x78 | ![#FF7978](image/color_FF7978.png) |
| 0xA | Dark yellow  | 0xD4 | 0xC1 | 0x54 | ![#D4C154](image/color_D4C154.png) |
| 0xB | Light yellow | 0xE6 | 0xCE | 0x80 | ![#E6CE80](image/color_E6CE80.png) |
| 0xC | Dark green   | 0x21 | 0xB0 | 0x3B | ![#21B03B](image/color_21B03B.png) |
| 0xD | Magenta      | 0xC9 | 0x5B | 0xBA | ![#C95BBA](image/color_C95BBA.png) |
| 0xE | Gray         | 0xCC | 0xCC | 0xCC | ![#CCCCCC](image/color_CCCCCC.png) |
| 0xF | White        | 0xFF | 0xFF | 0xFF | ![#FFFFFF](image/color_FFFFFF.png) |

### 1.2) レジスタ

8 つの制御レジスタ（0~7）と 1 つのステータスレジスタがある。

#### (制御レジスタ)

| No. | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0  |
| --: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :----: |
|   0 |   -   |   -   |   -   |   -   |   -   |   -   |  M2   | EXTVID |
|   1 | 4/16K |  BL   | GINT  |  M1   |  M3   |   -   |  SI   |  MAG   |
|   2 |   -   |   -   |   -   |   -   | PN13  | PN12  | PN11  |  PN10  |
|   3 | CT13  | CT12  | CT11  | CT10  |  CT9  |  CT8  |  CT7  |  CT6   |
|   4 |   -   |   -   |   -   |   -   |   -   | PG13  | PG12  |  PG11  |
|   5 |   -   | SA13  | SA12  | SA11  | SA10  |  SA9  |  SA8  |  SA7   |
|   6 |   -   |   -   |   -   |   -   |   -   | SG13  | SG12  |  SG11  |
|   7 |  TC3  |  TC2  |  TC1  |  TC0  |  BD3  |  BD2  |  BD1  |  BD0   |

- M1/M2/M3: 画面モード
- EXTVID: 拡張ビデオ入力の有効化フラグ
- 4/16K: 0 = 4KB RAM, 1 = 16KB RAM
- BL: 0 = 画面がブランク状態になりスプライトサブシステムが非アクティブ
- GINT: 1 = 割り込みを生成
- SI: 0 = 8x8 スプライト, 1 = 16x16 スプライト
- MAG: 1 = スプライトサイズが倍になる
- PN\*: パターンネームテーブルのアドレス
- SA\*: スプライト属性テーブルのアドレス
- SG\*: スプライト生成テーブルのアドレス
- TC\*: テキストカラー（フォアグラウンド）
- BD\*: ボーダー色（0 の場合は 1=黒と等価）

#### (ステータスレジスタ)

| Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  INT  |  5S   |   C   |  FS4  |  FS3  |  FS2  |  FS1  |  FS0  |

- INT: 画面更新時に 1 になり割り込みに使用
- 5S: 5 番目のスプライト（表示されていない）を検出時に 1 になる
- C: スプライト衝突時に 1 になる
- FS\*: 5 番目のスプライト番号（5S がセット時のみ）

> TODO: 続きを書く
