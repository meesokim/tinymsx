# V9938 MSX-VIDEO

## 本書について

V9938 は MSX2 で採用された VDP であり、本書は Eugeny Brychkov 氏によるドキュメント [V9938-programmers-guide.pdf](http://rs.gr8bit.ru/Documentation/V9938-programmers-guide.pdf) - Rev. 1.01c (Apr 10, 2018) をベースにしています。
純粋な邦訳ではなく、所々意訳したり再編しています。
また、TMS9918A 互換仕様に関しては基本的に、本リポジトリの [TMS9918A.md](TMS9918A.md) を参照する形にします。

## 目次

```text
1. BASIC INPUT AND OUTPUT
  1.1. Accessing the Control Registers
    1.1.1. Direct access to VDP registers
    1.1.2. Indirect access to registers through R#17 (Control Register Pointer)
  1.2. Accessing the Palette Registers
  1.3. Accessing the Status Registers
  1.4. Accessing the Video RAM
2. REGISTER FUNCTIONS
  2.1. Control registers
    2.1.1. Mode registers
    2.1.2. Table Base address registers
    2.1.3. Color registers
    2.1.4. Display registers
    2.1.5. Access registers
    2.1.6. Command registers
  2.2. Status registers #0 to #9
3. SCREEN MODES
  3.1. TEXT1 mode
  3.2. TEXT2 mode
  3.3. MULTICOLOR (MC) mode
  3.4. GRAPHIC1 (G1) mode
  3.5. GRAPHIC2 (G2) and GRAPHIC3 (G3) modes
  3.6. GRAPHIC4 (G4) mode
  3.7. GRAPHIC5 (G5) mode
  3.8. GRAPHIC6 (G6) mode
  3.9. GRAPHIC7 (G7) mode
4. COMMANDS
  4.1. Types of Commands
  4.2. Page concept
  4.3. Logical Operations
  4.4. Explanations of Commands
    4.4.1. HMMC (High-speed move CPU to VRAM)
    4.4.2. YMMM (High speed move VRAM to VRAM, y only)
    4.4.3. HMMM (High speed move VRAM to VRAM)
    4.4.4. HMMV (High-speed move VDP to VRAM)
    4.4.5. LMMC (Logical move CPU to VRAM)
    4.4.6. LMCM (Logical move VRAM to CPU)
    4.4.7. LMMM (Logical move VRAM to VRAM)
    4.4.8. LMMV (logical move VDP to VRAM)
    4.4.9. LINE
    4.4.10. SRCH
    4.4.11. PSET
    4.4.12. POINT
  4.5. Speeding up the processing of commands
  4.6. States of the registers after command execution
5. SPRITES
  5.1. Sprite mode 1 (G1, G2, MC)
  5.2. Sprite mode 2 (G3, G4, G5, G6, G7)
  5.3. Special rules for sprite color settings
6. SPECIAL FUNCTIONS
  6.1. Alternate display of two graphics screen pages
  6.2. Displaying two graphics screens at 60Hz
  6.3. Interlace display
```

## 1. BASIC INPUT AND OUTPUT

V9938 の基本入出力は [TMS9918A](TMS9918A.md) の上位互換ですが、[TMS9918A](TMS9918A.md) の未使用領域を使うため、完全な互換性はありません。
そのため、TMS9918A の undocumented な方法や一部のマイナーな機能を使用している MSX1 のプログラムは、MSX2 では正常に動作しない可能性があります。

### 1.1. Accessing the Control Registers

V9938 は ポート#0 ～ ポート#3 の 4 つのポートを持ちます:

- ポート#0 ($98)
  - VRAM Data (R/W)
- ポート#1 ($99)
  - Status Register (R)
  - VRAM Address (W)
  - Register set-up (W)
- ポート#2 ($9A)
  - Palette registers (W)
- ポート#3 ($9B)
  - Register indirect addressing (W)

MSX-VIDEO コントロールレジスタ（R#0 ～ R#46）にデータを設定する方法は 2 通りあります。

#### 1.1.1. Direct access to VDP registers

ポート#1 にデータとレジスタ番号を順番に出力します。
VDP ポートへの読み書きの順番は非常に重要なので、この順番は、VDP ポートへの書き込みや読み出しが可能な CPU の割り込みルーチンによって中断される可能性があることを覚えておく必要があり、その結果、適切なシーケンスが中断されます。
Z80 CPU の場合は、開始時に DI(割り込み禁止) を使用し、VDP の最後に EI(割り込み許可) を使用してアクセスコードを設定してください。

データバイトが先に書き込まれ（ビット D0 ～ D7）、データバイトの隣にレジスタ番号が書き込まれます（ビット R0 ～ R5）。
この 2 つの動作の間に VDP 動作を伴う割り込みが発生した場合、予測できない結果が発生する可能性があります。

| Sequence            | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 | Memo            |
| :------------------ | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :-------------- |
| Port #1 first byte  |  D7   |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   | Data            |
| Port #1 second byte |   1   |   0   |  R5   |  R4   |  R3   |  R2   |  R1   |  R0   | Register number |

#### 1.1.2. Indirect access to registers through R#17 (Control Register Pointer)

R#17 にダイレクトアドレッシングでレジスタ番号を設定し、ポート#3 にデータを送信します。
R#17 に書き込まれた値の MSB(AII)は、レジスタ番号のオートインクリメントを制御します。

- オートインクリメントが有効になっている場合: 各データの読み出しまたは書き込み後に制御レジスタのポインタがインクリメントされる
- オートインクリメントが無効になっている場合: R#17 のポインタの値は変更されないままになります

オートインクリメントモードは、VDP レジスタの一括読み出しや更新に便利です。

| Sequence     | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 | Memo            |
| :----------- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :-------------- |
| Register #17 |  AII  |   0   |  R5   |  R4   |  R3   |  R2   |  R1   |  R0   | Register number |
| Port #3      |  D7   |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   | Data            |

- AII (auto increment) 0 = enable, 1 = disable

### 1.2. Accessing the Palette Registers

MSX-VIDEO のパレットレジスタ(P#0 ～ P#15)にデータを設定するには、まずレジスタ R#16(カラーパレットアドレスポインター)にパレットレジスタ番号を設定してから、ポート #2 に 2 バイトのデータ(特定の順番で)を書き込む必要があります。
各色は赤、緑、青の 3 つのビット（値 0 ～ 7）で構成されています。

> - 注 1: ポート#2 にデータを書き込んだ後、レジスタ R#16 のパレットレジスタ番号(ポインタ)がオートインクリメントされます。
> - 注 2: ポート#2 のラッチはポート#1 のラッチと共用されるかが不明（SMS の VDP の場合は共用されている）

| Sequence            | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2  | Bit-1  | Bit-0  | Memo           |
| :------------------ | :---: | :---: | :---: | :---: | :---: | :----: | :----: | :----: | :------------- |
| Register #16        |   0   |   0   |   0   |   0   |  P3   |   P2   |   P1   |   P0   | Palette number |
| Port #2 first byte  |   0   | Red2  | Red1  | Red0  |   0   | Blue2  | Blue1  | Blue0  | Color (RB)     |
| Port #2 second byte |   0   |   0   |   0   |   0   |   0   | Green2 | Green1 | Green0 | Color (G)      |

### 1.3. Accessing the Status Registers

MSX-VIDEO のステータスレジスタ（S#0 ～ S#9）を読み出すには、まず R#15（ステータスレジスタポインタ）にレジスタ番号を設定し、ポート#1 からデータを読み出す必要があります。

| Sequence             | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 | Memo          |
| :------------------- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :------------ |
| Register #15 (write) |   0   |   0   |   0   |   0   |  S3   |  S2   |  S1   |  S0   | Status number |
| Port #1 data (read)  |  D7   |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   | Status        |

### 1.4. Accessing the Video RAM (VRAM)

128K バイトの VRAM に 64K バイトの拡張 RAM を加えたものを VDP に装着することができます。

メモリにアクセスするには、以下の手順で行います。

1. R#45 write: 各バンク（VRAM または拡張 RAM）を切り替え
2. R#14 write: アドレスカウンタ A16 ~ A14 を設定
3. Port#1 write: アドレスカウンタ A7 ~ A0 と A13 ~ A8 を設定 & 以降のデータコマンドの read or write を設定
4. Port#0 read/write: データコマンド（メモリへのデータの読み書き）

Step 4 (Port#0 read/write) を実行する毎に VRAM アドレスがインクリメントされます。

| Sequence             | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 | Memo               |
| :------------------- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :----------------- |
| Register #45         |   0   |  MXC  |   ?   |   ?   |   ?   |   ?   |   ?   |   ?   | VRAM bank select   |
| Register #14         |   0   |   0   |   0   |   0   |   0   |  A16  |  A15  |  A14  | VRAM address       |
| Port #1 first byte   |  A7   |  A6   |  A5   |  A4   |  A3   |  A2   |  A1   |  A0   | VRAM address       |
| Port #1 second byte  |   0   |  R/W  |  A13  |  A12  |  A11  |  A10  |  A9   |  A8   | VRAM address & R/W |
| Port #0 (read/write) |  D7   |  D6   |  D5   |  D4   |  D3   |  D2   |  D1   |  D0   | VRAM data          |

- MXC: 0 = VRAM, 1 = 拡張 RAM
- R/W: 0 = Read, 1 = Write

## 2. REGISTER FUNCTIONS

### 2.1. Control registers

R#0 ~ R#23, R#32 ~ R#46 が制御レジスタです。

#### 2.1.1. Mode registers

| Register | Bit-7 | Bit-6 | Bit-5 | Bit-4 | Bit-3 | Bit-2 | Bit-1 | Bit-0 | Memo          |
| :------- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :------------ |
| R#0      |   0   |  DG   |  IE2  |  IE1  |  M5   |  M4   |  M3   |   0   | Mode register |
| R#1      |   0   |  BL   |  IE0  |  M1   |  M2   |   0   |  SI   |  MAG  | Mode register |
| R#8      |  MS   |  LP   |  TP   |  CB   |  VR   |   0   |  SPD  |  BW   | Mode register |
| R#9      |  LN   |   0   |  S1   |  S0   |  IL   |  EO   | \*NT  |  DC   | Mode register |

\* Indicates negative logic

- R#0
  - **DG:** デジタイズモード: カラーバスを入力または出力モードに設定します
  - **IE2:** ライトペンからの割り込みを有効にする
  - **IE1:** 水平リトレースからの割り込みを有効にする
  - **M5~M3:** 画面モードフラグ (see Screen Modes chapter)
- R#1:
  - **BL:** 空白画面: 1 に設定すると画面表示が有効になります。0 に設定すると、画面表示は無効となり、VRAM の読み出し操作は行われません。
  - **IE0:** 垂直リトレースからの割り込みを有効にする
  - **M2~M1:** 画面モードフラグ (see Screen Modes chapter)
  - **SI:** スプライトサイズ: 1 に設定するとスプライトサイズは 16x16 になります．0 にするとスプライトサイズは 8x8 になります
  - **MAG:** スプライトの拡大: 1 に設定するとスプライトを拡大（2 倍）します
- R#8:
  - **MS:** マウス: 1 に設定すると、カラーバスを入力モードに設定してマウスを有効にします。0 に設定すると、カラーバスを出力モードに設定してマウスを無効にします。
  - **LP:** ライトペン: 1 に設定すると、ライトペンを有効にします。
  - **TP:** コード 0 の色をパレットの色に設定します
  - **CB:** カラーバス: 1 に設定すると、カラーバスを入力モードにします。0 に設定すると、カラーバスを出力モードにします。
  - **VR:** VRAM の種類と構成を選択します。1 に設定すると、VRAM は 64Kx1Bit または 64Kx4Bits になります。0 に設定すると、VRAM は 16Kx1Bit または 16Kx4Bits になります。VDP が DRAM チップ上でどのようにリフレッシュを実行するかに影響します。
  - **SPD:** スプライト無効化: 1 に設定するとスプライトが表示されず，関連する VRAM の読み込みも行われなくなります
  - **BW:** 黒/白: 1 に設定されている場合、画面出力が 32 階調のグレースケールになります
- R#9:
  - **LN:** Line: 1 に設定すると、垂直方向のドット数が 212 になります。0 に設定すると、垂直方向のドット数は 192 になります。
  - **S1~S0:** 同時モードを選択します。
  - **IL:** インターレース: 1 に設定するとインターレース、0 に設定するとノンインターレースモードになります。
  - **EO:** 偶数/奇数画面。1 に設定すると、偶数/奇数フィールドで 2 つのグラフィック画面を交互に表示し、0 に設定すると、同じグラフィック画面を偶数/奇数フィールドで表示します。
  - **\*NT:** (RGB 出力のみ) 1 に設定すると PAL モード (313 スキャンライン & 50Hz)、0 に設定すると NTSC モード (262 スキャンライン & 60Hz) になります。
  - **DC:** ドットクロック: 1 に設定すると \*DLCLK が入力モード、0 に設定すると \*DLCKL が出力モードになります。

(TODO)
